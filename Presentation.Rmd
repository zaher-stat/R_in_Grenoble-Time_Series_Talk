---
title: "Time Series"
subtitle:  "Analysis and Forecasting in R"
author: "Ahmed ZAHER"
institute: "&#x26f0;&#xfe0f; R in Grenoble Session"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: xaringan-themer.css
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      beforeInit: "macros.js"
    seal: false
---



```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
library(WDI)
library(dplyr)
library(rnaturalearth)
library(tidyverse)
library(ggplot2)
library(ggthemes)
library(ggrepel)
library(icons)
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_mono_light(
  header_font_google = google_font("Josefin Slab", "600"),
  text_font_google   = google_font("Work Sans", "300", "300i"),
  code_font_google   = google_font("IBM Plex Mono"),
  title_slide_background_image = "all-ok.PNG",
  title_slide_background_size = "95%",
  title_slide_background_position = "bottom",
  base_color = "#000000",
  code_inline_color = "#13A10E",
  link_color = "#13A10E",
  code_font_size = "0.7em"
)
```

```{r xaringanExtra-clipboard, echo=FALSE}
xaringanExtra::use_clipboard()
```

```{r xaringanExtra-share-again, echo=FALSE}
xaringanExtra::use_share_again()
```

```{r xaringan-panelset, echo=FALSE}
xaringanExtra::use_panelset()
```

count: false

class: inverse, center, title-slide, middle

<style>
.title-slide .remark-slide-number {
  display: none;
}
</style>

# Time Series 

## Analysis and Forecasting in R

### [`Ahmed ZAHER`](https://lpnc.univ-grenoble-alpes.fr/Ahmed-ZAHER)

### &#x26f0;&#xfe0f; R in Grenoble Session

#### 26 June 2021


---

count: false

class: inverse, lift, top

# Outlines:

- What is a Time Series?

- Understanding your Time Series

- How to make a time series stationary?

- ARIMA Models

- Autocorrelation and Partial-Autocorrelation

- Forecasting Using an ARIMA Model

---

`Time Series in R`

- Any metric that is measured over regular time intervals makes a Time Series. 
e.g.: Weather data, Stock prices, Industry forecasts...

--

*Example: Economic Time Series data from ggplot2 package*


```{r ,, error=FALSE, message=FALSE, warning=FALSE }
# load economics Time Series data from ggplot2
library(ggplot2)
# Demo dataset
head(economics)

```

--

*Selecting psavert and uempmed datas*

```{r, message=FALSE, warning=FALSE, error=FALSE, fig.align='center'}
library(tidyr)
library(dplyr)
df <- economics %>%
  select(date, psavert, uempmed) %>%
  gather(key = "variable", value = "value", -date)

```

---

`Plotting Series`

```{r, message=FALSE, warning=FALSE, error=FALSE, fig.width=10, fig.height=5, fig.align='center'}
# Multiple line plot
ggplot(df, aes(x = date, y = value)) + 
  geom_line(aes(color = variable), size = 1) +
  scale_color_manual(values = c("#00AFBB", "#E7B800")) +
  theme_minimal()
```

==> Other methods to plot time series are described in the [Tutorial](https://github.com/zaher-stat/R_in_Grenoble-Time_Series_Talk)

---

`Personal savings rate time series analysis`

```{r}
# get psavert data
df <- economics %>%
  select(date, psavert)

# time period
min(df$date)
max(df$date)

# convert it to a time serie
psavert <- stats::ts(df$psavert, frequency = 12, start = c(1967, 7), end = c(2015, 4))
psavert
```

---

`Plotting Time Series Object`

```{r , fig.align='center'}
stats::plot.ts(psavert, ylab="Personal savings rate", xlab="Year")
```

---

`Components of a Time Series`

- Each data point a Time Series ( $Y_t$ ) can be expressed as either a sum or a product of three components : 

Seasonality ( $S_t$ ), Trend ( $T_t$ ) and Error ( $\epsilon_t$ ) (a.k.a White Noise)


- Additive Time Series : $Y_t = S_t + T_t + \epsilon_t$


- Multiplicative Time Series : $Y_t = S_t * T_t * \epsilon_t$


A multiplicative time series can be converted to additive by taking a log of the time series.

--

<center>

![Additive vs Multiplicative time series](Add_vs_Mult.jpeg)


---

`Extract components`

```{r, fig.align='center'}

decomposeTS <- stats::decompose(psavert, type = "add")
plot(decomposeTS)


```

---

`Stationary Time Series`

Being stationary requires that the mean and variance of a time series are constant for the whole series.
That can be fixed by differencing the series or by applying another transformation. Differencing is the process of subtracting one observation from another and can be done on any number of observations.


```{r, fig.align='center', fig.height=5}
psavert_SA <- psavert - decomposeTS$seasonal # Seasonally Adjusting
psavert_SA_diff1 <- diff(psavert_SA, differences = 1) # Differentiated series
## ΔGDP_t = GDP_t - GDP_{t-1}
plot(psavert_SA_diff1)
```


---

`The optimal number of diffs`

```{r, message=FALSE, warning=FALSE,error=FALSE}
library(forecast)
ndiffs(x = psavert_SA)
```

```{r, fig.align='center', fig.height=6}
plot(diff(psavert_SA, 1))
```

---

`ARIMA Models`

**Auto Regressive Integrated Moving Average** is a class of models that explains a given Time Series based on its own past values (lags and lagged forecast errors). So that equation can be used to forecast future values.

--

An ARIMA model is characterized by 3 terms: $ARIMA(p, d, q)$

where :

- $p$ is the order of the $AR$ term

$$Y_t = \beta_1 Y_{t-1} + \beta_2 Y_{t-2} + ... + \beta_p Y_{t-p} + \epsilon_t$$

- $q$ is the order of the $MA$ term

$$Y_t = \epsilon_t - \theta_1 \epsilon_{t-1} - ... - \theta_q \epsilon_{t-q}$$

- $d$ is the number of differencing required to make the time series stationary

$$(1-L)^d Y_t$$

---

`Selecting a condidate Model`

To do this, we need to examine the correlogram and partial correlogram of the stationary time series.

- __Correlogram__: represents the autocorrelation that measures the linear relationship between lagged values of a time series.

- __Partial correlogram__: represents the partial autocorrelation function that measures the correlation between observations of a time series that are separated by k time units ( $Y_t$ and $Y_{t–k}$ ), after adjusting for the presence of all the other terms of shorter lag ( $Y_{t–1}$, $Y_{t–2}$, ..., $Y_{t–k-1}$ ).

==> The partial autocorrelation at lag k is the correlation that results after removing the effect of any correlations due to the terms at shorter lags.

To plot a correlogram and partial correlogram, we can use the _Acf()_ and _Pacf()_ functions in R.

---

`Selecting a condidate Model`

**Correlogram for psavert Time Series**


```{r, message=FALSE, warning=FALSE, error=FALSE, fig.height=4, fig.width=6, fig.pos='center'}

Acf(psavert_SA_diff1, lag.max=20)             # plot a correlogram
Acf(psavert_SA_diff1, lag.max=20, plot=FALSE) # get the autocorrelation values

```


---

`Selecting a condidate Model`

**Partial correlogram for psavert Time Series**

```{r, message=FALSE, warning=FALSE, error=FALSE, fig.height=4, fig.width=6, fig.pos='center'}

Pacf(psavert_SA_diff1, lag.max=20)             # plot a partial correlogram
Pacf(psavert_SA_diff1, lag.max=20, plot=FALSE) # get the partial autocorrelation values

```


---

`Selecting a condidate Model`


Since the correlogram is zero after lag 1, and the partial correlogram tails off to zero after lag 3, this means that the following ARMA (autoregressive moving average) models are possible for the time series of first differences:

- an ARMA(3,0) model, that is, an autoregressive model of order p=3, since the partial autocorrelogram is zero after lag 3, and the autocorrelogram tails off to zero (although perhaps too abruptly for this model to be appropriate)

- an ARMA(0,1) model, that is, a moving average model of order q=1, since the autocorrelogram is zero after lag 1 and the partial autocorrelogram tails off to zero

- an ARMA(p,q) model, that is, a mixed model with p and q greater than 0, since the autocorrelogram and partial correlogram tail off to zero (although the correlogram probably tails off to zero too abruptly for this model to be appropriate)

---

`Automatic selection`

```{r}

## Automatic processing
fit <- auto.arima(psavert_SA)
summary(fit)

```

---

`Forecasting`

_forecast()_ function is used to make prediction for the next five following periodes (short-term forecasts):

```{r message=FALSE, warning=FALSE, error=FALSE, fig.height=4, fig.width=6, fig.pos='center'}

forecastedValues <- forecast(fit, h=15)
plot(forecastedValues)

forecastedValues$mean

```


---

`Model validation`

```{r message=FALSE, warning=FALSE, error=FALSE, fig.height=4, fig.width=6, fig.pos='center'}

Acf(forecastedValues$residuals, lag.max=20)
Box.test(forecastedValues$residuals, lag=20, type="Ljung-Box")

```

---

count: false

class: inverse, center

<br><br><br><br><br><br>

.center[
# Thank you!

]

